version: 2

jobs:
  build:
    docker:
      - image: hoangitdct/docker-compose:17.03.x-ce # primary image

    working_directory: touch_app

    environment:
      TEST_RESULTS: /tmp/test-results

    steps:
      - checkout

      - setup_remote_docker

      - run:
          name: Start container and verify it's working
          command: |
            set -x
            cd devops/dockers/backend
            chmod +x ./runner.sh
            docker-compose -f docker-compose.test.yml up
            echo $?

      - deploy:
          name: Build and push Docker image
          command: |
            echo "deployment"

      - store_artifacts:
          path: /tmp/test-results
          destination: raw-test-output

      - store_test_results:
          path: /tmp/test-results
